generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================================================
// CORE USER & AUTH
// ============================================================================

model User {
  id                 String   @id @unique
  email              String   @unique
  hackClubId         String   @unique
  firstName          String?
  lastName           String?
  slackId            String?
  verificationStatus String?
  yswsEligible       Boolean  @default(false)
  createdAt          DateTime @default(now())

  sessions            Session[]
  enrollments         ProgramEnrollment[]
  workshopsCreated    Workshop[]           @relation("WorkshopAuthor")
  workshopCompletions WorkshopCompletion[]
  weeklyShips         WeeklyShip[]
  payouts             AmbassadorPayout[]
}

model Session {
  id        String   @id
  userId    String
  expiresAt DateTime
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

// ============================================================================
// PROGRAM SEASONS & ENROLLMENT
// ============================================================================

model ProgramSeason {
  id             String   @id @default(cuid())
  name           String   // "Resolution S1"
  slug           String   @unique // "s1"
  signupOpensAt  DateTime
  signupClosesAt DateTime // after this = late join
  startsAt       DateTime
  endsAt         DateTime
  totalWeeks     Int      @default(8)
  isActive       Boolean  @default(true)
  createdAt      DateTime @default(now())

  enrollments  ProgramEnrollment[]
  workshops    Workshop[]
  weeklyShips  WeeklyShip[]
  completions  WorkshopCompletion[]
  payouts      AmbassadorPayout[]
}

enum ProgramRole {
  PARTICIPANT
  AMBASSADOR
}

enum EnrollmentStatus {
  ACTIVE
  DROPPED
  COMPLETED
}

model ProgramEnrollment {
  id           String           @id @default(cuid())
  userId       String
  seasonId     String
  role         ProgramRole
  status       EnrollmentStatus @default(ACTIVE)
  joinedAt     DateTime         @default(now())
  startingWeek Int              @default(1) // 1 = on time, 2+ = late joiner
  createdAt    DateTime         @default(now())

  user   User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  season ProgramSeason @relation(fields: [seasonId], references: [id], onDelete: Cascade)

  @@unique([userId, seasonId, role])
}

// ============================================================================
// WORKSHOPS
// ============================================================================

enum Pathway {
  PYTHON
  WEB_DEV
  GAME_DEV
  HARDWARE
  DESIGN
  GENERAL_CODING
}

enum Difficulty {
  BEGINNER
  INTERMEDIATE
  ADVANCED
}

model Workshop {
  id             String     @id @default(cuid())
  authorId       String
  seasonId       String
  title          String
  description    String
  pathway        Pathway
  difficulty     Difficulty
  estimatedHours Int
  published      Boolean    @default(false)
  createdAt      DateTime   @default(now())
  updatedAt      DateTime   @updatedAt

  author      User                 @relation("WorkshopAuthor", fields: [authorId], references: [id], onDelete: Cascade)
  season      ProgramSeason        @relation(fields: [seasonId], references: [id], onDelete: Cascade)
  completions WorkshopCompletion[]
  analytics   WorkshopAnalytics?
  payoutItems AmbassadorPayoutItem[]
  weeklyShips WeeklyShip[]
}

model WorkshopCompletion {
  id            String    @id @default(cuid())
  workshopId    String
  participantId String
  seasonId      String
  projectUrl    String? // proof of shipping
  startedAt     DateTime  @default(now())
  completedAt   DateTime?

  workshop    Workshop      @relation(fields: [workshopId], references: [id], onDelete: Cascade)
  participant User          @relation(fields: [participantId], references: [id], onDelete: Cascade)
  season      ProgramSeason @relation(fields: [seasonId], references: [id], onDelete: Cascade)

  @@unique([workshopId, participantId, seasonId])
}

model WorkshopAnalytics {
  id                String   @id @default(cuid())
  workshopId        String   @unique
  views             Int      @default(0)
  starts            Int      @default(0)
  completions       Int      @default(0)
  avgCompletionMins Float? // average time to complete in minutes
  updatedAt         DateTime @updatedAt

  workshop Workshop @relation(fields: [workshopId], references: [id], onDelete: Cascade)
}

// ============================================================================
// WEEKLY SHIPPING (CORE TO RESOLUTION)
// ============================================================================

enum WeeklyShipStatus {
  PLANNED
  IN_PROGRESS
  SHIPPED
  MISSED
}

model WeeklyShip {
  id         String           @id @default(cuid())
  userId     String
  seasonId   String
  workshopId String? // optional: ties ship to a specific workshop
  weekNumber Int // 1-8
  goalText   String
  status     WeeklyShipStatus @default(PLANNED)
  proofUrl   String? // demo / repo / screenshot
  notes      String?
  shippedAt  DateTime?
  createdAt  DateTime         @default(now())
  updatedAt  DateTime         @updatedAt

  user     User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  season   ProgramSeason  @relation(fields: [seasonId], references: [id], onDelete: Cascade)
  workshop Workshop?      @relation(fields: [workshopId], references: [id], onDelete: SetNull)

  @@index([userId, seasonId, weekNumber])
}

// ============================================================================
// AMBASSADOR PAYOUTS
// ============================================================================

enum PayoutStatus {
  DRAFT
  PENDING
  PAID
  CANCELED
}

model AmbassadorPayout {
  id           String       @id @default(cuid())
  ambassadorId String
  seasonId     String
  amountCents  Int // total payout in cents
  status       PayoutStatus @default(DRAFT)
  periodStart  DateTime
  periodEnd    DateTime
  paidAt       DateTime?
  createdAt    DateTime     @default(now())

  ambassador User                   @relation(fields: [ambassadorId], references: [id], onDelete: Cascade)
  season     ProgramSeason          @relation(fields: [seasonId], references: [id], onDelete: Cascade)
  items      AmbassadorPayoutItem[]
}

model AmbassadorPayoutItem {
  id                     String @id @default(cuid())
  payoutId               String
  workshopId             String
  completionCount        Int // frozen at payout time
  rateCentsPerCompletion Int // 5000-10000 ($50-$100)
  amountCents            Int

  payout   AmbassadorPayout @relation(fields: [payoutId], references: [id], onDelete: Cascade)
  workshop Workshop         @relation(fields: [workshopId], references: [id], onDelete: Cascade)
}
